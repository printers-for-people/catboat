# Tests Firmware retraction G10 and G11

DICTIONARY atmega2560.dict
CONFIG firmware_retraction.cfg

CLEAR_RETRACTION
G90
VERIFY_AXIS_POSITION AXIS=e EXPECTED=0.0
G28

####################################################### TESTING FIMWARE RETRACTION
G1 X90.0 Y90.0 Z20.0

SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=0 Z_HOP_HEIGHT=2.0
# Test CLEAR_RETRACTION while unretracted
CLEAR_RETRACTION
CHECK_RECTRACTION_CLEARED

# Test CLEAR_RETRACTION while retracted
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=22
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5
CLEAR_RETRACTION
CHECK_RECTRACTION_CLEARED
CHECK_ZHOP_CLEARED
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=22
G1 X90.0 Y90.0
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=20
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5

# Unretract after clearing retraction
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=20
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5

# Test CLEAR_RETRACTION while retracted, 2nd go
SET_RETRACTION Z_HOP_HEIGHT=3.0
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5
CLEAR_RETRACTION
CHECK_RECTRACTION_CLEARED
CHECK_ZHOP_CLEARED
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
G1 X90.0 Y90.0
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=20
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5.0

# Test Clear_zhop on home 
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20.0
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
G28
CHECK_ZHOP_CLEARED
G1 X90.0 Y90.0 Z20.0
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5

# Test Clear_zhop on z moves
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20.0
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
G1 X100.0 
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
G1 Z30.0
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=30
CHECK_ZHOP_CLEARED
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
G11
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=30
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5
G1 Z20.0

# Test RESET_RETRACTION
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
RESET_RETRACTION
G1 X90.0 Y90.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=23
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=20
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-8
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=20.4
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5
VERIFY_TOOLHEAD_POSITION AXIS=z EXPECTED=20
M118 Test successful!
